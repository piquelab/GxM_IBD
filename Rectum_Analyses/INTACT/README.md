# Identification of IBD risk genes with combination of colocalization and TWAS  

Last Edited by JW, 4/14/2024. 
The working directory is in the path `/rs/rs_grp_ibdeqtl/IBD_shreya_2024/IBD_Recturm2_2024-04-14/`. 

  
We first prepare required input files as follows,
- `IBD_Rectum.bed.gz`, gene expression file, from  `/rs/rs_grp_ibdeqtl/FastQTL/rectum_protein_coding_residuals/qnorm_residuals_analysis/IBD-eQTL_Rectum_covariate_corrected_voom-q-norm.bed.gz`
- `IBD_Rectum.vcf.gz`, genotype file, 
```
### snpinfor 
bcftools query  -f '%CHROM\t%POS\t%REF\t%ALT\t%ID\n' IBD_Rectum.vcf.gz | bgzip > snpinfor.txt.gz`

### sample ID
bcftools query -l IBD_Recturm.vcf.gz > sample_ID.txt
```
- `IBD_Rectum_PC1-17.covariates.txt`, covariates file
- `./0_torus/IBD_Rectum_nominals_all_chunks.txt.gz`, summary data of eqtl mapping generated by Shreya, from `/rs/rs_grp_ibdeqtl/FastQTL/rectum_protein_coding_residuals/qnorm_residuals_analysis/permutations/fastQTL.output/IBD_Rectum_nominals_all_chunks.txt.gz`.   
If we don't have eqtl results, we need to do fastqtl mapping using the script `/rs/rs_grp_ibdeqtl/IBD_shreya_2024/IBD_Rectum/0_FastQTL/`.    

  
## Use torus to do enrichment analysis for eqtl mapping in the folder `0_torus` 
We ran torus to get prior information from eqtl summary data, which will be used for dap-g in the fine-mapping procedures. Include the following procedures
- `1_prepare.R`, prepare input files for torus
- `2_run_torus.sh`, the script for running torus    

## Use dap-g for fine-mapping in the folder `1_DAP-G`
Split geneList files
```
cd geneList
split -l 500 geneList.txt -d -a 3 splitGene
ls . |grep split > ../geneList_files.txt
```
- `1_batch_process.sh` using `batch_process.pl` to extract each gene expression and cis snp bed file
- `2_batch_assemble_submit.sh` using `assemble_sbams2.pl` to assemble gene expression, pcs and cis snp genotype for each gene into a single file 
- `3_run_dap-g.submit.sh`, fine-mapping for each gene
- `4_parse_submit.sh`, parse fine-mapping outputs. After that run commond `cat ./dap-g_parse_outs/*.SNP.out |awk '{print $1, $3, $4}' |bgzip > IBD_Rectum_PIP.txt.gz & `  


## Prepare gwas data in the folder `2_gwas_prepare`
- the subfolder `./impute/`, using the closest SNPs within 10kb region to be gwas values of the missing SNPs. The missing SNPs are those that the variants with minimum P or top PIP were detected in eqtl data while not in the gwas data.  
- the subfolder `./torus/`, using `torus` algorithm to fine-map gwas data


## Colocalization analysis using fastenloc in the folder `3_enloc` 
- In the first step, we prepare eqtl input data from dap-g procedures by running the script `1_enloc_format.sh`. Before, run `ln -s ../1_DAP-G/dap-g_outs/ dap_rst_dir`.  
- In the second step, we need replace snp id by rs id  that was used in eqtl mapping, the script `2_gwas_rs.R`. I have done it before and so I just copy it.   
- Find the total SNPs in the gwas `zcat ./gwas_PIP2/IBD.EUR.*.pip.gz | awk '{print $1}' | sort | uniq > snpList_gwas.txt &`. 
- The script `3_batch_enloc.sh` for colocalization analysis. For `-total_variants` I set to be number variants in gwas data.



## TWAS analysis using SMR in the folder `4_TWAS_smr` 
For the input data, we used the results of above procedure, SNPs for each gene and imputed gwas results. 
- SMR for twas analysis
- INTACT analysis, under `R version test_4.2.2`
  
